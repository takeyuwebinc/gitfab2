# スパムキーワード管理機能設計書

**機能名**: スパムキーワード管理機能
**機能ID**: SPAM-002
**バージョン**: 1.0
**作成日**: 2026年1月11日
**更新日**: 2026年1月11日

## 1. 機能概要

### 1.1 目的

管理画面でスパムキーワードを管理し、キーワードを含む投稿を拒否することで、スパム対応業務の効率化を図る。

- スパムキーワードによる自動検出で手動対応件数を削減
- 管理画面でのキーワード管理による柔軟な運用
- 伏字付きエラーメッセージによる善意のユーザーへの配慮

### 1.2 主要機能

1. **キーワード管理機能**: 管理画面でスパムキーワードのCRUD操作
2. **キーワード検出機能**: プロジェクト・コメント投稿時にキーワードを検出
3. **投稿拒否機能**: キーワード検出時に伏字付きエラーメッセージを表示して拒否

### 1.3 処理フロー概要

#### 1.3.1 キーワード管理フロー

1. 管理者がスパムキーワード管理画面にアクセス
2. キーワードの追加/編集/削除/有効・無効切り替えを実行
3. 変更は即時反映

#### 1.3.2 キーワード検出フロー

1. ユーザーがプロジェクト/コメントを投稿
2. 投稿内容に対してスパムキーワード検出を実行
3. キーワードが検出された場合、伏字付きエラーメッセージを表示して拒否
4. キーワードが検出されなかった場合、通常どおり保存

## 2. データ要件

### 2.1 新規データ

#### 2.1.1 スパムキーワード

**テーブル名**: `spam_keywords`

| 項目名 | キー | データ型 | 必須 | デフォルト | 説明 |
|--------|------|----------|------|-----------|------|
| id | PK | bigint | ○ | | ID |
| keyword | UK | varchar(255) | ○ | | スパム判定に使用するキーワード |
| enabled | | boolean | ○ | true | 有効フラグ |
| created_at | | datetime | ○ | | 作成日時 |
| updated_at | | datetime | ○ | | 更新日時 |

**制約**:
- UNIQUE KEY(keyword): キーワードの重複を防止
- keyword: 空文字不可、255文字以内

**目的**:
- スパム判定に使用するキーワードの管理
- 有効/無効の切り替えによる柔軟な運用

### 2.2 既存データ（参照）

#### 2.2.1 プロジェクト

**テーブル名**: `projects`

| 項目名 | 説明 |
|--------|------|
| name | プロジェクト名（検出対象） |
| title | タイトル（検出対象） |
| description | 説明（検出対象） |

#### 2.2.2 プロジェクトコメント

**テーブル名**: `project_comments`

| 項目名 | 説明 |
|--------|------|
| body | 本文（検出対象） |

#### 2.2.3 カードコメント

**テーブル名**: `card_comments`

| 項目名 | 説明 |
|--------|------|
| body | 本文（検出対象） |

#### 2.2.4 ユーザー

**テーブル名**: `users`

| 項目名 | 説明 |
|--------|------|
| authority | 権限（admin: システム管理者は検出対象外） |

## 3. 処理ロジック

### 3.1 キーワード管理処理

#### 3.1.1 キーワード一覧取得

**入力**: なし

**処理手順**:
1. spam_keywordsテーブルから全レコードを取得
2. 作成日時の降順でソート

**出力**: スパムキーワード一覧

#### 3.1.2 キーワード追加

**入力**:
- keyword: キーワード文字列
- enabled: 有効フラグ（省略時true）

**処理手順**:
1. **バリデーション**
   - keywordが空文字でないことを確認
   - keywordが255文字以内であることを確認
   - 同一キーワードが存在しないことを確認（大文字・小文字は区別）
2. **レコード作成**
   - spam_keywordsテーブルに新規レコードを作成

**出力**:
- 処理結果（成功/失敗）
- 失敗時のエラー内容

#### 3.1.3 キーワード編集

**入力**:
- id: キーワードID
- keyword: キーワード文字列
- enabled: 有効フラグ

**処理手順**:
1. **対象レコード取得**
   - 指定IDのレコードを取得
   - レコードが存在しない場合はエラー
2. **バリデーション**
   - 3.1.2と同様のバリデーションを実行
   - 重複チェックは自身を除外
3. **レコード更新**
   - 対象レコードを更新

**出力**:
- 処理結果（成功/失敗）
- 失敗時のエラー内容

#### 3.1.4 キーワード削除

**入力**:
- id: キーワードID

**処理手順**:
1. **対象レコード取得**
   - 指定IDのレコードを取得
   - レコードが存在しない場合はエラー
2. **レコード削除**
   - 対象レコードを物理削除

**出力**:
- 処理結果（成功/失敗）

#### 3.1.5 有効/無効切り替え

**入力**:
- id: キーワードID

**処理手順**:
1. **対象レコード取得**
   - 指定IDのレコードを取得
2. **フラグ反転**
   - enabledフラグを反転して保存

**出力**:
- 処理結果（成功/失敗）

### 3.2 キーワード検出処理

#### 3.2.1 スパムキーワード検出

**入力**:
- content: 検出対象の文字列（単一または複数）

**処理手順**:
1. **有効キーワード取得**
   - enabled = true のキーワード一覧を取得
2. **キーワード検出**
   - 各キーワードについて、検出対象文字列に部分一致するか判定
   - 大文字・小文字を区別しない（case-insensitive）
3. **結果返却**
   - いずれかのキーワードが検出された場合、検出されたキーワードを返す
   - 検出されなかった場合、nil を返す

**出力**:
- 検出結果（検出されたキーワード / nil）

#### 3.2.2 プロジェクト作成時の検出

**検出対象フィールド**:
- name（プロジェクト名）
- title（タイトル）
- description（説明）

**検出タイミング**:
- プロジェクト作成処理の実行前

#### 3.2.3 プロジェクト更新時の検出

**検出対象フィールド**:
- name（プロジェクト名）
- title（タイトル）
- description（説明）

**検出タイミング**:
- プロジェクト更新処理の実行前

#### 3.2.4 コメント投稿時の検出

**検出対象フィールド**:
- body（本文）

**検出タイミング**:
- コメント作成処理の実行前

**対象コメント種別**:
- プロジェクトコメント（ProjectComment）
- カードコメント（CardComment）

### 3.3 伏字生成処理

#### 3.3.1 伏字生成ロジック

**入力**:
- keyword: 検出されたキーワード

**処理手順**:
1. **文字数判定**
   - キーワードが3文字以下の場合 → 伏字なし
   - キーワードが4文字以上の場合 → 伏字あり
2. **伏字生成（4文字以上の場合）**
   - 先頭1文字を取得
   - 末尾1文字を取得
   - 中間部分を「*」で置換（文字数分）

**出力**:
- 伏字付きキーワード（4文字以上の場合）
- nil（3文字以下の場合）

**伏字生成例**:

| 元のキーワード | 文字数 | 伏字表示 |
|---------------|--------|----------|
| `casino` | 6文字 | `c****o` |
| `viagra` | 6文字 | `v****a` |
| `無料プレゼント` | 7文字 | `無*****ト` |
| `稼げる` | 3文字 | （伏字なし） |
| `ab` | 2文字 | （伏字なし） |

### 3.4 投稿拒否処理

#### 3.4.1 投稿拒否の実装方針

**目的**:
スパムキーワードが検出された投稿を拒否し、ユーザーに修正の機会を与える。

**動作**:
1. 投稿リクエストを受け付ける
2. スパムキーワード検出を実行
3. 検出された場合：
   - データベースへの保存を行わない
   - 伏字付きエラーメッセージを表示
   - 入力内容を保持したまま画面を再表示
4. 検出されなかった場合：
   - 通常どおり保存処理を実行

**エラーメッセージ**:

| 条件 | メッセージ |
|------|-----------|
| 4文字以上のキーワード検出 | 「禁止されているキーワード「{伏字}」が含まれているため、投稿できませんでした。内容を修正してください。」 |
| 3文字以下のキーワード検出 | 「禁止されているキーワードが含まれているため、投稿できませんでした。内容を修正してください。」 |

**注意点**:
- ログには検出情報を記録する（調査・監査目的）
- Spammer登録は行わない（誤検知の可能性があるため）

## 4. ビジネスルール

### 4.1 キーワード管理ルール

#### 4.1.1 キーワードの形式

- 空文字は登録不可
- 前後の空白はトリムして保存
- 最大255文字
- 日本語、英語、記号など任意の文字列を登録可能

#### 4.1.2 重複制御

- 同一キーワードは1つのみ登録可能
- 重複チェックは完全一致（大文字・小文字は区別）
- 既存キーワードと重複する場合はバリデーションエラー

#### 4.1.3 有効/無効の扱い

- 新規登録時のデフォルトは「有効」
- 無効化されたキーワードは検出対象外
- 無効化しても削除はされない（履歴として保持可能）

### 4.2 検出ルール

#### 4.2.1 検出条件

- 部分一致で判定（キーワードが検出対象文字列の一部に含まれていれば検出）
- 大文字・小文字を区別しない
- 有効なキーワード（enabled = true）のみが検出対象

#### 4.2.2 検出時の動作

- 投稿を拒否し、伏字付きエラーメッセージを表示
- 投稿者のSpammer登録は行わない（誤検知の可能性があるため）
- ログに検出情報を記録（日時、ユーザーID、検出キーワード、投稿内容の一部）

### 4.3 伏字表示ルール

#### 4.3.1 伏字の適用条件

| キーワード文字数 | 伏字 | 表示例 |
|-----------------|------|--------|
| 4文字以上 | あり | 先頭1文字 + 「*」×(文字数-2) + 末尾1文字 |
| 3文字以下 | なし | キーワード自体を表示しない |

#### 4.3.2 伏字適用の理由

- 4文字以上：伏字でも推測は困難だが、ユーザーは修正箇所のヒントを得られる
- 3文字以下：伏字にしても容易に推測可能なため、キーワードを表示しない

### 4.4 処理の優先順位

1. システム管理者チェック（対象外なら検出スキップ）
2. スパムキーワード検出
3. 投稿拒否（検出時）/ 通常処理（非検出時）

## 5. 画面表示機能

### 5.1 スパムキーワード一覧画面

**URL**: `/admin/spam_keywords`

#### 5.1.1 画面構成

- **ヘッダー部**: 画面タイトル、新規追加ボタン
- **一覧テーブル**: キーワード一覧を表示
- **ページネーション**: 件数が多い場合に表示

#### 5.1.2 一覧テーブル

| カラム | 内容 |
|--------|------|
| キーワード | 登録されているキーワード |
| ステータス | 有効/無効の状態 |
| 登録日時 | 作成日時 |
| 操作 | 編集/削除/有効・無効切り替えボタン |

#### 5.1.3 操作ボタン

- **新規追加**: キーワード登録フォームを表示
- **編集**: 対象キーワードの編集フォームを表示
- **削除**: 確認ダイアログ表示後に削除
- **有効/無効切り替え**: ワンクリックでステータス切り替え

### 5.2 キーワード登録/編集フォーム

#### 5.2.1 フォーム構成

| 項目 | 入力形式 | 必須 | 説明 |
|------|----------|------|------|
| キーワード | テキストボックス | ○ | 255文字以内 |
| 有効 | チェックボックス | ○ | デフォルト: オン |

#### 5.2.2 バリデーションメッセージ

| 条件 | メッセージ |
|------|-----------|
| キーワード未入力 | 「キーワードを入力してください」 |
| キーワード重複 | 「このキーワードは既に登録されています」 |
| 文字数超過 | 「キーワードは255文字以内で入力してください」 |

### 5.3 フラッシュメッセージ

#### 5.3.1 管理画面操作時のメッセージ

| 操作 | 成功メッセージ |
|------|---------------|
| 追加 | 「スパムキーワードを追加しました」 |
| 編集 | 「スパムキーワードを更新しました」 |
| 削除 | 「スパムキーワードを削除しました」 |
| 有効化 | 「スパムキーワードを有効にしました」 |
| 無効化 | 「スパムキーワードを無効にしました」 |

#### 5.3.2 削除確認ダイアログ

- 内容：「このスパムキーワードを削除しますか？」
- ボタン：「削除」「キャンセル」

### 5.4 投稿拒否時のエラー表示

#### 5.4.1 エラーメッセージ表示

- プロジェクト作成/更新フォームのエラーエリアに表示
- コメント投稿フォームのエラーエリアに表示
- 入力内容は保持され、修正後に再投稿可能

#### 5.4.2 エラーメッセージ例

```
禁止されているキーワード「c****o」が含まれているため、投稿できませんでした。内容を修正してください。
```

```
禁止されているキーワードが含まれているため、投稿できませんでした。内容を修正してください。
```

## 6. 実装設計

### 6.1 モデル

#### 6.1.1 SpamKeyword モデル

**ファイル**: `app/models/spam_keyword.rb`

**責務**:
- スパムキーワードのCRUD操作
- バリデーション（必須チェック、重複チェック、文字数チェック）
- 有効キーワードのスコープ提供
- 伏字生成

**バリデーション**:
- `keyword`: presence, uniqueness, length(maximum: 255)
- `enabled`: inclusion(in: [true, false])

**スコープ**:
- `enabled`: 有効なキーワードのみ取得

**インスタンスメソッド**:
- `masked_keyword`: 伏字付きキーワードを返す（3文字以下はnil）

### 6.2 サービス

#### 6.2.1 SpamKeywordDetector サービス

**ファイル**: `app/services/spam_keyword_detector.rb`

**責務**:
- スパムキーワード検出ロジックの実装
- 複数フィールドに対する一括検出
- 除外条件（管理者）のチェック

**クラスメソッド**:
- `detect(user:, contents:)`: スパムキーワードを検出し、検出されたSpamKeywordオブジェクトを返す（検出なしの場合はnil）

**使用例**:
```ruby
detected_keyword = SpamKeywordDetector.detect(
  user: current_user,
  contents: [project.name, project.title, project.description]
)

if detected_keyword
  # 投稿拒否処理
  flash[:alert] = detected_keyword.rejection_message
  render :new
else
  # 通常の保存処理
  project.save
end
```

### 6.3 コントローラー

#### 6.3.1 Admin::SpamKeywordsController

**ファイル**: `app/controllers/admin/spam_keywords_controller.rb`

**責務**:
- スパムキーワード管理画面の制御
- CRUD操作のハンドリング

**アクション**:
- `index`: 一覧表示
- `new`: 新規登録フォーム表示
- `create`: 新規登録処理
- `edit`: 編集フォーム表示
- `update`: 更新処理
- `destroy`: 削除処理
- `toggle_enabled`: 有効/無効切り替え

### 6.4 ビュー

#### 6.4.1 管理画面ビュー

**ファイル構成**:
- `app/views/admin/spam_keywords/index.html.slim`: 一覧画面
- `app/views/admin/spam_keywords/new.html.slim`: 新規登録画面
- `app/views/admin/spam_keywords/edit.html.slim`: 編集画面
- `app/views/admin/spam_keywords/_form.html.slim`: フォームパーシャル

### 6.5 ルーティング

```ruby
namespace :admin do
  resources :spam_keywords do
    member do
      patch :toggle_enabled
    end
  end
end
```

### 6.6 投稿処理への組み込み

#### 6.6.1 プロジェクト作成/更新

**対象コントローラー**: `ProjectsController`

**組み込み箇所**:
- `create`アクション: 保存前にスパム検出
- `update`アクション: 更新前にスパム検出

**実装方針**:
- before_actionまたはサービスクラスで検出処理を実行
- 検出時は保存をスキップし、エラーメッセージを表示

#### 6.6.2 コメント投稿

**対象コントローラー**: `ProjectCommentsController`, `CardCommentsController`

**組み込み箇所**:
- `create`アクション: 保存前にスパム検出

**実装方針**:
- before_actionまたはサービスクラスで検出処理を実行
- 検出時は保存をスキップし、エラーメッセージを表示

## 7. ログ出力

### 7.1 検出ログ

スパムキーワードが検出された場合、以下の情報をログに出力する。

**出力レベル**: INFO

**出力内容**:
- 検出日時
- ユーザーID
- 投稿種別（プロジェクト/プロジェクトコメント/カードコメント）
- 検出されたキーワード
- 投稿内容の先頭100文字

**出力例**:
```
[SpamKeywordDetector] Spam keyword detected: user_id=123, type=Project, keyword="casino", content="This is the content..."
```

### 7.2 管理操作ログ

キーワードの追加/編集/削除時、以下の情報をログに出力する。

**出力レベル**: INFO

**出力内容**:
- 操作日時
- 操作者（管理者ID）
- 操作種別（追加/編集/削除/有効化/無効化）
- 対象キーワード

## 8. 前提条件・制約事項

### 8.1 前提条件

- 管理画面（Admin機能）が存在すること
- 管理者権限を持つユーザーのみがキーワード管理画面にアクセス可能であること

### 8.2 制約事項

- スパムキーワード検出は投稿時のみ行う（既存投稿の遡及チェックは行わない）
- キーワード検出時のSpammer登録は行わない（誤検知の可能性があるため）
- 検出ログは通常のアプリケーションログに出力（専用のログテーブルは作成しない）

### 8.3 パフォーマンス考慮

- 有効キーワードはメモリにキャッシュし、投稿ごとのDBアクセスを削減
- キャッシュはキーワード変更時に自動的に無効化

## 9. テスト観点

### 9.1 キーワード管理機能

- [ ] キーワードを追加できること
- [ ] キーワードを編集できること
- [ ] キーワードを削除できること
- [ ] 有効/無効を切り替えられること
- [ ] 空文字のキーワードは登録できないこと
- [ ] 重複するキーワードは登録できないこと
- [ ] 255文字を超えるキーワードは登録できないこと

### 9.2 キーワード検出機能

- [ ] 有効なキーワードを含むプロジェクト作成がエラーメッセージ付きで拒否されること
- [ ] 有効なキーワードを含むプロジェクト更新がエラーメッセージ付きで拒否されること
- [ ] 有効なキーワードを含むコメント投稿がエラーメッセージ付きで拒否されること
- [ ] 大文字・小文字を区別せずに検出されること
- [ ] 無効化されたキーワードは検出対象外であること
- [ ] システム管理者の投稿は検出対象外であること
- [ ] キーワードが含まれない投稿は正常に保存されること

### 9.3 伏字表示機能

- [ ] 4文字以上のキーワードは伏字付きで表示されること
- [ ] 3文字以下のキーワードは伏字なしでメッセージのみ表示されること
- [ ] 伏字は先頭1文字と末尾1文字が表示され、中間が「*」になること

### 9.4 投稿拒否機能

- [ ] 拒否時にエラーメッセージが表示されること
- [ ] 拒否時に入力内容が保持されること
- [ ] 拒否時にデータが保存されていないこと
- [ ] 拒否時に検出ログが出力されること

---

**関連資料**:
- [プロジェクト管理機能改修 要件定義書](../requirements/project-management-improvement.md)
- [まとめてスパム認定機能設計書](./batch-spam-designation.md)
