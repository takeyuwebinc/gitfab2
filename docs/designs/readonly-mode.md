# 一時的なリードオンリーモード機能設計書

**機能名**: 一時的なリードオンリーモード
**機能ID**: SPAM-001
**バージョン**: 1.0
**作成日**: 2026年1月11日
**更新日**: 2026年1月11日

## 1. 機能概要

### 1.1 目的

システム管理者が緊急時にサイト全体の投稿・編集機能を一時的に制限し、スパム攻撃やボット攻撃による被害を最小限に抑える。

- スパム攻撃発生時の緊急対応手段の提供
- 全ユーザー（システム管理者含む）の投稿・編集操作を一括制限
- 指定日時での自動解除による運用負荷軽減

### 1.2 主要機能

1. **リードオンリーモード切替機能**: 管理画面からモードの有効化/無効化を設定
2. **自動解除機能**: 指定した日時に自動でモードを解除
3. **バナー通知機能**: サイト全体にリードオンリーモード中であることを告知
4. **書き込み制限機能**: 制限対象の操作を拒否しエラーメッセージを表示

### 1.3 処理フロー概要

#### 1.3.1 リードオンリーモード有効化フロー

1. システム管理者が管理画面でリードオンリーモードを有効化
2. 自動解除日時を任意で設定
3. 設定を保存
4. 自動解除日時が設定されている場合、解除ジョブをスケジュール
5. サイト全体にバナーが表示される

#### 1.3.2 書き込み制限フロー

1. ユーザーが制限対象の操作を試行
2. リードオンリーモードが有効か判定
3. 有効の場合、エラーメッセージを表示して操作を拒否
4. 無効の場合、通常の処理を継続

#### 1.3.3 自動解除フロー

1. 指定した自動解除日時に到達
2. バックグラウンドジョブがリードオンリーモードを無効化
3. バナーが非表示になる
4. ユーザーが通常どおり操作可能になる

## 2. データ要件

### 2.1 リードオンリーモード設定

**格納先**: システム設定テーブル（既存）

| キー | データ型 | 必須 | 説明 |
|------|----------|------|------|
| readonly_mode_enabled | boolean（文字列として保存） | ○ | モードの有効/無効（"true"/"false"） |
| readonly_mode_expires_at | datetime（文字列として保存） | - | 自動解除日時（未設定の場合はnil） |

**補足**:
- 既存のシステム設定テーブル（key-value形式）を利用
- 値は文字列として保存し、取得時に適切な型に変換

## 3. 処理ロジック

### 3.1 リードオンリーモード判定処理

#### 3.1.1 判定ロジック

**入力**:
- なし（システム設定を参照）

**処理手順**:
1. システム設定からリードオンリーモードの有効/無効を取得
2. 有効な場合、自動解除日時を確認
3. 自動解除日時が過去の場合、モードを無効化して返す
4. それ以外の場合、設定値をそのまま返す

**出力**:
- true: リードオンリーモード中
- false: 通常モード

**キャッシュ戦略**:
- 判定は毎回データベースを参照せず、キャッシュを利用
- 設定変更時にキャッシュをクリア

### 3.2 書き込み制限処理

#### 3.2.1 制限対象の操作

**プロジェクト**
- 新規作成
- 更新

**プロジェクト内カード**
- State（進捗状態カード）の作成・更新・削除
- Annotation（注釈カード）の作成・更新・削除
- NoteCard（メモカード）の作成・更新・削除
- Usage（使い方カード）の作成・更新・削除

**コメント**
- プロジェクトコメントの投稿・削除
- カードコメントの投稿・削除

#### 3.2.2 制限処理

**入力**:
- HTTPリクエスト（制限対象の操作）

**処理手順**:
1. リードオンリーモード判定を実行
2. リードオンリーモード中の場合：
   - エラーメッセージを設定
   - 適切なレスポンスを返す（HTMLの場合はリダイレクト、JSONの場合はエラーレスポンス）
3. リードオンリーモード中でない場合：
   - 通常の処理を継続

**出力**:
- HTML形式: リダイレクトとフラッシュメッセージ
- JSON形式: エラーレスポンス（HTTPステータス 503 Service Unavailable）

**エラーメッセージ**:
- "The site is currently in maintenance mode. Posting and editing are temporarily unavailable."

### 3.3 自動解除処理

#### 3.3.1 解除ジョブ

**入力**:
- なし（スケジュールされた時刻に実行）

**処理手順**:
1. リードオンリーモードの設定を確認
2. 有効かつ自動解除日時が現在時刻以前の場合：
   - リードオンリーモードを無効化
   - 自動解除日時をクリア
   - キャッシュをクリア
   - ログを出力
3. それ以外の場合：
   - 何もしない（既に解除済み、または手動解除された）

**出力**:
- ログ出力（解除実行時）

#### 3.3.2 ジョブスケジューリング

**入力**:
- 自動解除日時

**処理手順**:
1. 既存のスケジュール済みジョブがあればキャンセル
2. 指定日時にジョブをスケジュール

**注意点**:
- 自動解除日時が変更された場合、古いジョブをキャンセルして新しいジョブをスケジュール
- リードオンリーモードが手動解除された場合、スケジュール済みジョブをキャンセル

## 4. ビジネスルール

### 4.1 制限ルール

#### 4.1.1 例外なし

- リードオンリーモード中は、システム管理者を含む全てのユーザーが制限対象
- APIリクエストも制限対象
- バックグラウンド処理からの操作も制限対象（ただし自動解除ジョブは除く）

#### 4.1.2 制限対象外

- 閲覧操作（プロジェクト表示、検索など）
- 管理画面での操作（リードオンリーモード設定含む）
- ログイン/ログアウト

### 4.2 処理優先順位

要件定義書に従い、リードオンリーモードは他の制限条件より優先される。

| 優先度 | 条件 | 動作 |
|--------|------|------|
| 1 | リードオンリーモード中 | エラーメッセージを表示し、投稿を拒否 |
| 2 | スパム投稿者 | サイレント拒否 |
| 3 | reCAPTCHA検証失敗 | エラーメッセージを表示し、投稿を拒否 |
| 4 | スパムキーワード検出 | エラーメッセージを表示し、投稿を拒否 |

**注意点**:
- リードオンリーモード中は、スパム投稿者であってもサイレント拒否ではなくエラーメッセージを表示
- これは緊急対応時であることをユーザーに明示するため

### 4.3 自動解除ルール

#### 4.3.1 解除タイミング

- 設定した自動解除日時に到達した時点で解除
- 日時を過ぎてからサイトにアクセスした場合も、その時点で解除

#### 4.3.2 解除の競合

- 自動解除日時前に手動解除された場合、自動解除ジョブは何も行わない
- 自動解除日時が変更された場合、新しい日時で再スケジュール

## 5. 画面表示機能

### 5.1 管理画面 - リードオンリーモード設定

#### 5.1.1 表示項目

| 項目名 | 入力形式 | 必須 | 説明 |
|--------|----------|------|------|
| モードの有効化/無効化 | チェックボックス | ○ | リードオンリーモードのON/OFF |
| 自動解除日時 | 日時入力 | - | 指定した日時に自動で解除（任意） |

#### 5.1.2 操作

- **保存**: 設定を保存し、必要に応じて自動解除ジョブをスケジュール
- **キャンセル**: 変更を破棄

#### 5.1.3 バリデーション

- 自動解除日時は現在時刻より未来であること
- 自動解除日時はモード有効化時のみ設定可能

### 5.2 サイト全体 - バナー表示

#### 5.2.1 表示条件

- リードオンリーモードが有効な場合に表示
- 全ページ共通（ヘッダー直下）
- 全ユーザー（ログイン/未ログイン問わず）に表示

#### 5.2.2 表示内容

- メッセージ: "The site is currently in maintenance mode."
- 背景色: 警告色（例: 黄色または橙色系）

### 5.3 制限対象操作時のエラー表示

#### 5.3.1 HTML形式（フォーム送信）

- フラッシュメッセージでエラーを表示
- 元のページにリダイレクト

#### 5.3.2 JSON形式（API/Ajax）

- HTTPステータス: 503 Service Unavailable
- レスポンスボディ: エラーメッセージを含むJSON

### 5.4 エラーハンドリング

#### 5.4.1 エラー分類

| エラーレベル | 説明 | 処理継続 |
|-------------|------|----------|
| INFO | リードオンリーモード有効化/無効化 | 継続 |
| INFO | 自動解除実行 | 継続 |
| WARN | 書き込み操作の拒否 | 中断（ユーザーにエラー表示） |

#### 5.4.2 ユーザーへの表示

- 制限対象の操作を試みた場合、エラーメッセージを表示
- バナーにより事前に制限中であることを通知

## 6. ログ出力機能

### 6.1 設定変更ログ

リードオンリーモードの設定が変更された場合にログを出力。

**出力レベル**: INFO

**出力内容**:
- 日時（ロガーが自動付与）
- 操作内容（有効化/無効化）
- 自動解除日時（設定時のみ）
- 操作者（管理者ID）

### 6.2 自動解除ログ

自動解除が実行された場合にログを出力。

**出力レベル**: INFO

**出力内容**:
- 日時（ロガーが自動付与）
- 解除実行

### 6.3 書き込み拒否ログ

リードオンリーモード中に書き込み操作が拒否された場合にログを出力。

**出力レベル**: WARN

**出力内容**:
- 日時（ロガーが自動付与）
- ユーザーID（ログイン時）
- IPアドレス
- リクエストパス

**出力目的**:
- 制限中の操作試行状況の監視
- 調査・監査目的

## 7. 前提条件・制約事項

### 7.1 前提条件

- **システム前提条件**:
  - 既存のシステム設定テーブルが存在すること
  - 既存の管理画面機能が存在すること
  - バックグラウンドジョブ基盤が稼働していること

### 7.2 制約事項

- **技術的制約**:
  - 自動解除はバックグラウンドジョブ基盤に依存
  - バックグラウンドジョブが停止している場合、自動解除日時を過ぎてもリクエスト時に判定して解除

### 7.3 依存関係

- 既存のシステム設定テーブル
- 既存の管理画面機能
- 既存のバックグラウンドジョブ基盤

## 8. テスト観点

### 8.1 リードオンリーモード切替機能

- [ ] 管理画面からリードオンリーモードを有効化できること
- [ ] 管理画面からリードオンリーモードを無効化できること
- [ ] 自動解除日時を設定できること
- [ ] 自動解除日時に過去の日時を設定した場合、バリデーションエラーになること

### 8.2 書き込み制限機能

- [ ] リードオンリーモード中、プロジェクト作成が拒否されること
- [ ] リードオンリーモード中、プロジェクト更新が拒否されること
- [ ] リードオンリーモード中、State/Annotation/NoteCard/Usageの作成・更新・削除が拒否されること
- [ ] リードオンリーモード中、コメントの投稿・削除が拒否されること
- [ ] リードオンリーモード中、エラーメッセージが表示されること
- [ ] 通常モード時、制限なく操作できること

### 8.3 自動解除機能

- [ ] 自動解除日時に到達した場合、モードが自動解除されること
- [ ] 自動解除後、バナーが非表示になること
- [ ] 自動解除後、操作が可能になること
- [ ] 手動解除後、自動解除ジョブが何も行わないこと

### 8.4 バナー表示機能

- [ ] リードオンリーモード中、全ページにバナーが表示されること
- [ ] 未ログインユーザーにもバナーが表示されること
- [ ] 通常モード時、バナーが表示されないこと

### 8.5 処理優先順位

- [ ] リードオンリーモード中にスパム投稿者が投稿を試みた場合、エラーメッセージが表示されること（サイレント拒否ではない）

### 8.6 ログ出力機能

- [ ] 設定変更時にログが出力されること
- [ ] 自動解除時にログが出力されること
- [ ] 書き込み拒否時にログが出力されること

---

**関連資料**:
- [スパムプロジェクト投稿抑制機能 要件定義書](../requirements/spam-prevention.md)
- [スパム投稿者のプロジェクト作成制限機能設計書](./spammer-project-creation-restriction.md)
