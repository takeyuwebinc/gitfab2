# スパム検出ログ機能設計書

**機能名**: スパム検出ログ機能
**バージョン**: 1.0
**作成日**: 2026年1月23日
**更新日**: 2026年1月23日

## 1. 機能概要

### 1.1 目的
- スパム検出機能によってブロックされた投稿の記録を永続化する
- 管理者がスパム検出の動作状況を管理画面から確認できるようにする

### 1.2 主要機能
1. **ログ記録機能**: スパム検出によるブロック発生時に、検出情報をデータベースに記録する
2. **ログ一覧表示機能**: 管理画面でスパム検出ログを一覧表示する

### 1.3 処理フロー概要

#### 1.3.1 ログ記録処理
1. スパム検出機能がブロックを判定
2. ブロック発生時にログ記録処理を呼び出し
3. 検出情報をデータベースに保存

#### 1.3.2 ログ一覧表示処理
1. 管理者が管理画面でログ一覧ページにアクセス
2. ログデータを新しい順に取得
3. 一覧として表示

## 2. データ要件

### 2.1 スパム検出ログ

**テーブル名**: `spam_detection_logs`

| 項目名 | キー | データ型 | 必須 | 説明 |
|--------|------|----------|------|------|
| id | PK | bigint | ○ | 主キー |
| user_id | FK | bigint | ○ | ブロックされたユーザーのID |
| ip_address | | string | ○ | リクエスト元のIPアドレス |
| detection_method | | string | ○ | 検出方法（keyword, spammer, recaptcha） |
| detection_reason | | text | - | 検出理由の詳細情報 |
| content_type | | string | ○ | コンテンツ種別（Project, NoteCard等） |
| created_at | | datetime | ○ | 作成日時（検出日時） |
| updated_at | | datetime | ○ | 更新日時 |

**制約**:
- FOREIGN KEY(user_id) REFERENCES users（NULL許容）

**目的**:
- スパム検出によるブロックの記録を永続化する
- 管理者が検出状況を把握するためのデータを提供する

**データ作成タイミング**:
- スパムキーワード検出でブロックした時
- スパマー制限でサイレント拒否した時
- reCAPTCHA検証失敗でブロックした時

### 2.2 検出方法の値

| 値 | 説明 |
|----|------|
| keyword | スパムキーワード検出によるブロック |
| spammer | スパマー制限によるサイレント拒否 |
| recaptcha | reCAPTCHA検証失敗によるブロック |

### 2.3 検出理由の形式

| 検出方法 | 検出理由の内容 |
|----------|----------------|
| keyword | マッチしたキーワード |
| spammer | （空または「スパマー登録済み」等の固定文言） |
| recaptcha | reCAPTCHAスコアと閾値（例: "score=0.3, threshold=0.5"） |

## 3. ビジネスルール

### 3.1 ログ記録

#### 3.1.1 記録タイミング
- **スパムキーワード検出**: キーワードマッチが検出され、投稿がブロックされた時点
- **スパマー制限**: スパマー判定によりサイレント拒否が行われた時点
- **reCAPTCHA検証失敗**: reCAPTCHAスコアが閾値を下回り、投稿がブロックされた時点

#### 3.1.2 IPアドレスの取得
- リクエストからIPアドレスを取得する
- プロキシ経由の場合は適切なヘッダーから取得する

### 3.2 ログ一覧表示

#### 3.2.1 表示順序
- 検出日時の新しい順（降順）で表示

#### 3.2.2 ページネーション
- 一覧表示にはページネーションを適用する

## 4. 画面表示機能

### 4.1 画面構成

#### 4.1.1 管理画面メニュー
- 既存の管理画面のメニューに「スパム検出ログ」を追加

#### 4.1.2 ログ一覧画面
- **一覧テーブル**: ログの一覧を表示
- **ページネーション**: ページ送り

### 4.2 一覧表示仕様

#### 4.2.1 表示項目

| 項目 | 説明 |
|------|------|
| 検出日時 | ログの作成日時 |
| ユーザー | ユーザー名またはID（未ログインの場合は「-」等） |
| IPアドレス | リクエスト元のIPアドレス |
| 検出方法 | keyword / spammer / recaptcha |
| 検出理由 | マッチしたキーワード、スコア等 |
| コンテンツ種別 | Project、NoteCard等 |

### 4.3 エラーハンドリング

#### 4.3.1 ログ記録失敗時
- ログ記録に失敗しても、元のスパム検出処理には影響を与えない
- エラーはRailsログに出力する

## 5. 既存機能との統合

### 5.1 統合対象

#### 5.1.1 スパムキーワード検出
- 既存のスパムキーワード検出サービスにログ記録処理を追加

#### 5.1.2 スパマー制限
- 既存のスパマー制限処理にログ記録処理を追加

#### 5.1.3 reCAPTCHA検証
- 既存のreCAPTCHA検証サービスにログ記録処理を追加

### 5.2 統合方針
- ログ記録処理は既存の検出処理の後に実行する
- ログ記録の失敗が既存処理に影響しないよう、例外を適切に処理する

---

**関連資料**:
- [スパム検出ログ機能 要件定義書](../requirements/spam-detection-log.md)
- [スパムプロジェクト投稿抑制機能 要件定義書](../requirements/spam-prevention.md)
