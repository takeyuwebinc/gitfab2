# まとめてスパム認定機能設計書

**機能名**: まとめてスパム認定機能
**機能ID**: SPAM-001
**バージョン**: 1.0
**作成日**: 2026年1月6日
**更新日**: 2026年1月6日

## 1. 機能概要

### 1.1 目的

管理画面のプロジェクト一覧において、複数のスパムプロジェクトを一括でスパム認定できるようにする。

- スパム対応業務の効率化
- 大量発生時の対応時間短縮
- 操作ミスの防止（確認ダイアログによる）

### 1.2 主要機能

1. **複数選択機能**: プロジェクト一覧で複数のプロジェクトをチェックボックスで選択
2. **一括スパム認定機能**: 選択したプロジェクトを一括でスパム認定処理
3. **選択状態表示機能**: 現在の選択件数をリアルタイムで表示

### 1.3 処理フロー概要

#### 1.3.1 選択フェーズ

1. プロジェクト一覧画面を表示
2. 各プロジェクト行のチェックボックスで対象を選択
3. 選択件数がリアルタイムで更新表示される

#### 1.3.2 実行フェーズ

4. 「まとめてスパム認定」ボタンをクリック
5. 確認ダイアログで内容を確認
6. 「実行」で処理を開始

#### 1.3.3 処理フェーズ

7. 選択されたプロジェクトごとにスパム認定処理を実行
8. オーナーをSpammerとして登録
9. プロジェクトを論理削除
10. 処理結果を表示

## 2. データ要件

### 2.1 既存データ（参照）

#### 2.1.1 プロジェクト

**テーブル名**: `projects`

| 項目名 | キー | データ型 | 必須 | 説明 |
|--------|------|----------|------|------|
| id | PK | bigint | ○ | プロジェクトID |
| owner_type | | varchar | ○ | オーナー種別（User/Group） |
| owner_id | FK | bigint | ○ | オーナーID |
| deleted_at | | datetime | | 論理削除日時 |

**目的**:
- スパム認定対象のプロジェクト情報を取得
- オーナー情報からSpammer登録対象を特定

#### 2.1.2 スパム投稿者

**テーブル名**: `spammers`

| 項目名 | キー | データ型 | 必須 | 説明 |
|--------|------|----------|------|------|
| id | PK | bigint | ○ | ID |
| user_id | UK, FK | bigint | ○ | ユーザーID |
| created_at | | datetime | ○ | 作成日時 |
| updated_at | | datetime | ○ | 更新日時 |

**制約**:
- UNIQUE KEY(user_id)
- FOREIGN KEY(user_id) REFERENCES users

**目的**:
- スパム投稿者の管理
- 重複登録の防止

#### 2.1.3 グループメンバーシップ

**テーブル名**: `group_members`

| 項目名 | キー | データ型 | 必須 | 説明 |
|--------|------|----------|------|------|
| id | PK | bigint | ○ | ID |
| group_id | FK | bigint | ○ | グループID |
| user_id | FK | bigint | ○ | ユーザーID |

**目的**:
- グループオーナーの場合、メンバー全員をSpammer登録するために参照

## 3. 処理ロジック

### 3.1 スパム認定処理

#### 3.1.1 単一プロジェクトのスパム認定

**入力**:
- プロジェクトID

**処理手順**:

1. **オーナー種別の判定**
   - プロジェクトのowner_typeを確認
   - Userの場合 → 3.1.2へ
   - Groupの場合 → 3.1.3へ

2. **Spammer登録**
   - 対象ユーザーをspammersテーブルに登録
   - 既に登録済みの場合はスキップ

3. **プロジェクト論理削除**
   - deleted_atに現在日時を設定

**出力**:
- 処理結果（成功/失敗）
- 失敗時のエラー内容

#### 3.1.2 Userオーナーの場合

- オーナーユーザーをSpammerとして登録

#### 3.1.3 Groupオーナーの場合

- グループの全メンバーを取得
- 各メンバーをSpammerとして登録

### 3.2 一括処理

#### 3.2.1 一括スパム認定処理

**入力**:
- プロジェクトIDの配列

**処理手順**:

1. **バリデーション**
   - 選択件数が1件以上であることを確認
   - 選択されたプロジェクトが存在することを確認

2. **逐次処理**
   - 選択されたプロジェクトを1件ずつ処理
   - 各プロジェクトごとにトランザクションを適用
   - 1件の失敗が他の処理に影響しないようにする

3. **結果集計**
   - 成功件数をカウント
   - 失敗件数と原因を記録

**出力**:
- 処理結果サマリ（成功件数、失敗件数）
- 失敗したプロジェクトの情報

## 4. ビジネスルール

### 4.1 選択ルール

#### 4.1.1 選択範囲

- 選択対象は現在表示中のページ内のプロジェクトのみ
- ページをまたいだ選択は不可

#### 4.1.2 全選択の動作

- ヘッダーのチェックボックスで現在ページの全プロジェクトを選択/解除
- ページ遷移時は選択状態がリセットされる

### 4.2 処理ルール

#### 4.2.1 部分失敗時の動作

- 一部のプロジェクトで処理が失敗しても、残りのプロジェクトは継続して処理
- 失敗したプロジェクトの情報を処理完了後に表示

#### 4.2.2 Spammer登録の重複制御

- 既にSpammerとして登録済みのユーザーは再登録しない
- 重複登録の試行はエラーとせず、スキップして継続

#### 4.2.3 削除済みプロジェクトの扱い

- 既に論理削除済みのプロジェクトを選択した場合、オーナーのSpammer登録のみ実行
- プロジェクトの論理削除処理はスキップ

## 5. 画面表示機能

### 5.1 画面構成

#### 5.1.1 画面レイアウト

- **一括操作エリア**: 一覧上部に配置、選択件数と操作ボタンを表示
- **一覧テーブル**: 既存の一覧にチェックボックス列を追加
- **結果表示エリア**: 処理完了後、結果メッセージを表示

### 5.2 UI要素

#### 5.2.1 チェックボックス列

- 一覧テーブルの左端に配置
- ヘッダー行：全選択/全解除チェックボックス
- データ行：各プロジェクトの選択チェックボックス

#### 5.2.2 選択件数表示

- 一括操作エリアに表示
- 形式：「N件選択中」
- 選択状態の変更に応じてリアルタイム更新

#### 5.2.3 まとめてスパム認定ボタン

- 一括操作エリアに配置
- 未選択時は非活性（グレーアウト）
- 警告色で表示（操作の重要性を示す）

#### 5.2.4 確認ダイアログ

- ボタンクリック時に表示
- 内容：選択件数、処理内容の説明、確認メッセージ
- ボタン：「実行」「キャンセル」

### 5.3 エラーハンドリング

#### 5.3.1 エラー分類

| エラーレベル | 説明 | 処理継続 |
|-------------|------|----------|
| WARNING | 一部プロジェクトの処理失敗 | 継続 |
| ERROR | 全プロジェクトの処理失敗 | 中止 |
| INFO | 処理完了（部分成功含む） | - |

#### 5.3.2 エラーメッセージ例

```
成功: N件のプロジェクトをスパム認定しました
警告: N件のプロジェクトを処理しましたが、M件は失敗しました
エラー: 処理に失敗しました。しばらく経ってから再度お試しください
```

## 6. 処理の優先順位と制約

### 6.1 トランザクション管理

- 各プロジェクトの処理は独立したトランザクションで実行
- 1件の失敗が他のプロジェクトの処理に影響しない

### 6.2 前提条件

- 管理者権限を持つユーザーのみが操作可能
- 管理画面にログイン済みであること

### 6.3 制約事項

- 一括操作はページネーション単位（複数ページにまたがる選択は不可）
- 処理中の画面遷移は禁止（処理完了まで待機）

---

**関連資料**:
- [プロジェクト管理機能改修 要件定義書](../requirements/project-management-improvement.md)
