# スパム投稿者のプロジェクト作成制限機能設計書

**機能名**: スパム投稿者のプロジェクト作成制限機能
**機能ID**: SPAM-003
**バージョン**: 1.0
**作成日**: 2026年1月11日
**更新日**: 2026年1月11日

## 1. 機能概要

### 1.1 目的

既存のスパム投稿者管理基盤を活用し、スパム投稿者として登録されているユーザーの新規プロジェクト作成を制限する。

- スパム投稿者による新規プロジェクト作成を防止
- サイレント拒否により、スパム投稿者が制限を認識して対策を講じることを防止
- 既存のスパム投稿者管理機能との連携による効率的な運用

### 1.2 主要機能

1. **スパム投稿者判定機能**: プロジェクト作成時にユーザーがスパム投稿者かを判定
2. **サイレント拒否機能**: スパム投稿者の投稿を成功したように見せかけて拒否
3. **制限解除機能**: 管理画面からスパム投稿者レコードを削除することで制限を解除

### 1.3 処理フロー概要

#### 1.3.1 プロジェクト作成時の判定フロー

1. ユーザーがプロジェクト作成フォームを送信
2. スパム投稿者かどうかを判定
3. スパム投稿者の場合はサイレント拒否処理へ
4. スパム投稿者でない場合は通常の保存処理へ

#### 1.3.2 サイレント拒否フロー

1. プロジェクトを保存しない
2. サイレント拒否のログを出力
3. マイページ（プロジェクト一覧）にリダイレクト
4. フラッシュメッセージは表示しない

#### 1.3.3 制限解除フロー

1. 管理者が管理画面でスパム投稿者レコードを削除
2. 対象ユーザーのスパム投稿者判定がfalseになる
3. ユーザーは新規プロジェクト作成が可能になる

## 2. データ要件

### 2.1 既存データ（参照）

#### 2.1.1 スパム投稿者

**テーブル名**: `spammers`

| 項目名 | キー | データ型 | 必須 | 説明 |
|--------|------|----------|------|------|
| id | PK | bigint | ○ | ID |
| user_id | UK, FK | bigint | ○ | ユーザーID |
| detected_at | | datetime | ○ | スパムとして検知された日時 |
| created_at | | datetime | ○ | 作成日時 |
| updated_at | | datetime | ○ | 更新日時 |

**制約**:
- UNIQUE KEY(user_id)
- FOREIGN KEY(user_id) REFERENCES users

**目的**:
- スパム投稿者の管理
- 重複登録の防止

#### 2.1.2 ユーザー

**テーブル名**: `users`

| 項目名 | 説明 |
|--------|------|
| id | ユーザーID |
| authority | 権限（admin: システム管理者） |

**関連付け**:
- スパム投稿者テーブルと1対1の関連

**判定メソッド**:
- スパム投稿者かどうかを判定（スパム投稿者レコードの存在で判定）

#### 2.1.3 プロジェクト

**テーブル名**: `projects`

| 項目名 | キー | データ型 | 必須 | 説明 |
|--------|------|----------|------|------|
| id | PK | bigint | ○ | プロジェクトID |
| owner_type | | varchar | ○ | オーナー種別（User/Group） |
| owner_id | FK | bigint | ○ | オーナーID |
| name | | varchar(255) | ○ | プロジェクト名 |
| title | | varchar(255) | | タイトル |
| description | | text | | 説明 |

## 3. 処理ロジック

### 3.1 スパム投稿者判定処理

#### 3.1.1 判定ロジック

**入力**:
- ログイン中のユーザー

**処理手順**:
1. ユーザーに紐づくスパム投稿者レコードの存在を確認
2. レコードが存在する場合、スパム投稿者と判定
3. レコードが存在しない場合、通常ユーザーと判定

**出力**:
- true: スパム投稿者
- false: 通常ユーザー

### 3.2 サイレント拒否処理

#### 3.2.1 プロジェクト作成時のサイレント拒否

**入力**:
- プロジェクト作成リクエスト（名前、タイトル、説明等）

**処理手順**:
1. スパム投稿者判定を実行
2. スパム投稿者の場合：
   - プロジェクトオブジェクトを構築するが、保存しない
   - サイレント拒否のログを出力
   - マイページにリダイレクト
   - フラッシュメッセージは表示しない
3. スパム投稿者でない場合：
   - 通常の保存処理を継続

**出力**:
- スパム投稿者：マイページへのリダイレクト（メッセージなし）
- 通常ユーザー：通常のプロジェクト作成フロー

### 3.3 ログ出力処理

#### 3.3.1 サイレント拒否ログ

**入力**:
- ユーザーID
- アクション種別（プロジェクト作成）

**処理手順**:
1. INFOレベルでログを出力
2. 以下の情報を記録：
   - ユーザーID
   - アクション種別
   - サイレント拒否であることの明示

**出力形式**:
サイレント拒否であることを示す識別子、ユーザーID、アクション種別を含むログメッセージ

## 4. ビジネスルール

### 4.1 判定ルール

#### 4.1.1 スパム投稿者の判定条件

- スパム投稿者テーブルにユーザーのレコードが存在する場合、スパム投稿者と判定
- レコードの存在のみで判定し、検知日時等の値は参照しない

#### 4.1.2 システム管理者の扱い

- システム管理者であっても、スパム投稿者レコードが存在すれば制限対象
- ただし、通常の運用ではシステム管理者がスパム投稿者に登録されることは想定しない

### 4.2 処理優先順位

要件定義書に従い、複数の制限条件が該当する場合は以下の優先順位で処理する。

| 優先度 | 条件 | 動作 |
|--------|------|------|
| 1 | リードオンリーモード中 | エラーメッセージを表示し、投稿を拒否 |
| 2 | スパム投稿者 | サイレント拒否（成功したように見せかける） |
| 3 | reCAPTCHA検証失敗 | エラーメッセージを表示し、投稿を拒否 |
| 4 | スパムキーワード検出 | エラーメッセージを表示し、投稿を拒否 |

**注意点**:
- リードオンリーモード中は、スパム投稿者であってもリードオンリーモードのエラーメッセージを表示
- スパム投稿者かつreCAPTCHA検証失敗の場合、サイレント拒否が優先される
- スパム投稿者かつスパムキーワード検出の場合、サイレント拒否が優先される

### 4.3 サイレント拒否ルール

#### 4.3.1 サイレント拒否の動作

- フォーム送信後、マイページ（プロジェクト一覧）に遷移
- 成功時のフラッシュメッセージ（notice）は表示しない
- エラーメッセージ（alert）も表示しない
- 実際にはプロジェクトは作成されない

#### 4.3.2 サイレント拒否の目的

- スパム投稿者が制限を認識して対策を講じることを防止
- ボットによる自動投稿の場合、投稿失敗を検知されにくくする

### 4.4 制限解除ルール

#### 4.4.1 解除方法

- システム管理者が管理画面からスパム投稿者レコードを削除
- 削除後、対象ユーザーは即座に新規プロジェクト作成が可能になる

#### 4.4.2 解除権限

- システム管理者のみがスパム投稿者レコードの削除を実行可能

## 5. 画面表示機能

### 5.1 新規プロジェクト作成画面

#### 5.1.1 スパム投稿者の場合

- フォーム表示自体は通常どおり行う（制限の存在を隠蔽）
- フォーム送信後、マイページにリダイレクト
- フラッシュメッセージは表示しない

#### 5.1.2 通常ユーザーの場合

- 既存の動作どおり

### 5.2 マイページ（リダイレクト先）

#### 5.2.1 スパム投稿者がリダイレクトされた場合

- 通常のマイページを表示
- 作成しようとしたプロジェクトは一覧に表示されない（保存されていないため）
- 特別なメッセージは表示しない

### 5.3 エラーハンドリング

#### 5.3.1 エラー分類

| エラーレベル | 説明 | 処理継続 |
|-------------|------|----------|
| INFO | サイレント拒否（ログのみ） | 継続（マイページへリダイレクト） |

#### 5.3.2 ユーザーへの表示

- スパム投稿者に対してエラーメッセージは表示しない
- サイレント拒否のためユーザーには制限が分からない

## 6. ログ出力機能

### 6.1 サイレント拒否ログ

スパム投稿者の投稿がサイレント拒否された場合、以下の情報をログに出力する。

**出力レベル**: INFO

**出力内容**:
- 日時（ロガーが自動付与）
- ユーザーID
- アクション種別

**出力目的**:
- スパム投稿者の活動監視
- サイレント拒否の実行状況の確認
- 調査・監査目的

## 7. 前提条件・制約事項

### 7.1 前提条件

- **システム前提条件**:
  - 既存のスパム投稿者モデルが存在すること
  - ユーザーモデルにスパム投稿者判定機能が実装されていること
  - スパム投稿者管理画面が存在すること

### 7.2 制約事項

- **技術的制約**:
  - プロジェクト作成時のみ制限を適用（プロジェクト編集は制限対象外）
  - サイレント拒否のため、ユーザーには制限の存在が分からない

### 7.3 依存関係

- 既存のスパム投稿者モデル
- 既存の管理画面機能（スパム投稿者管理）

## 8. テスト観点

### 8.1 スパム投稿者判定機能

- [ ] スパム投稿者（スパム投稿者レコードあり）が正しく判定されること
- [ ] 通常ユーザー（スパム投稿者レコードなし）が正しく判定されること

### 8.2 サイレント拒否機能

- [ ] スパム投稿者がプロジェクト作成を試みた場合、マイページにリダイレクトされること
- [ ] スパム投稿者がプロジェクト作成を試みた場合、プロジェクトが保存されないこと
- [ ] スパム投稿者がプロジェクト作成を試みた場合、フラッシュメッセージが表示されないこと
- [ ] 通常ユーザーがプロジェクト作成した場合、正常に保存されること

### 8.3 処理優先順位

- [ ] リードオンリーモード中にスパム投稿者が投稿を試みた場合、エラーメッセージが表示されること
- [ ] スパム投稿者かつreCAPTCHA検証失敗の場合、サイレント拒否が優先されること
- [ ] スパム投稿者かつスパムキーワード検出の場合、サイレント拒否が優先されること

### 8.4 ログ出力機能

- [ ] サイレント拒否時にログが出力されること
- [ ] ログにユーザーIDとアクション種別が含まれること

### 8.5 制限解除機能

- [ ] スパム投稿者レコードを削除すると、対象ユーザーがプロジェクト作成可能になること

---

**関連資料**:
- [スパムプロジェクト投稿抑制機能 要件定義書](../requirements/spam-prevention.md)
- [まとめてスパム認定機能設計書](./batch-spam-designation.md)
- [スパムキーワード管理機能設計書](./spam-keyword-management.md)
