# 新規プロジェクト投稿時のreCAPTCHA機能設計書

**機能名**: 新規プロジェクト投稿時のreCAPTCHA機能
**機能ID**: SPAM-002
**バージョン**: 1.0
**作成日**: 2026年1月9日
**更新日**: 2026年1月9日

> **設計書作成ガイドライン**
>
> この機能設計書は、実装の詳細に影響されないコアドメインの設計を記載します。
> 具体的なクラス設計や実装詳細は、実装中の改善によって変化するため、
> 以下の点を重視して作成しています：
>
> - **責務の明確化**: 何をする処理かを明確に定義
> - **入出力の仕様**: 処理に必要な入力と期待される出力
> - **処理フローの概要**: 大まかな処理手順（実装方法は含めない）
> - **抽象度の保持**: 具体的なクラス名・メソッド名は記載しない
> - **ドメイン知識の記録**: 業務ルールやビジネス制約を重視

## 1. 機能概要

### 1.1 目的

新規プロジェクト作成時にreCAPTCHA v3による認証を行い、ボットによる自動投稿を防止する。

- ボットによる大量スパム投稿の抑制
- 人間によるフォーム送信との判別
- ユーザー体験を損なわない透過的な検証（v3はユーザー操作不要）

### 1.2 主要機能

1. **reCAPTCHAトークン取得**: フロントエンドでフォーム表示時にreCAPTCHA v3のトークンを自動取得
2. **トークン検証**: サーバー側でGoogle reCAPTCHA APIを使用してトークンを検証し、スコアを取得
3. **スコア判定**: 取得したスコアと閾値を比較し、ボット判定を行う
4. **閾値設定管理**: 管理画面からreCAPTCHAスコア閾値を設定可能

### 1.3 処理フロー概要

#### 1.3.1 フロントエンド処理

1. プロジェクト作成フォーム表示時にreCAPTCHA v3スクリプトをロード
2. フォーム送信時にreCAPTCHAトークンを非同期で取得
3. 取得したトークンをフォームデータに含めてサーバーに送信

#### 1.3.2 サーバーサイド処理

4. リクエストからreCAPTCHAトークンを取得
5. トークンが存在しない場合、エラーメッセージを表示し投稿を拒否
6. Google reCAPTCHA APIにトークン検証リクエストを送信
7. APIレスポンスからスコアを取得
8. スコアと閾値を比較してボット判定を実施
9. 判定結果に基づいてプロジェクト作成を許可または拒否

#### 1.3.3 エラー・例外処理

10. API障害時（タイムアウト、エラー応答）は検証をスキップして投稿を許可（フォールバック）
11. 検証失敗時はエラーメッセージを表示し、再試行を促す

## 2. データ要件

### 2.1 設定データ

#### 2.1.1 システム設定（reCAPTCHAスコア閾値）

reCAPTCHAのスコア閾値は、既存のシステム設定の仕組みを利用して管理する。

| 設定項目 | データ型 | デフォルト値 | 説明 |
|----------|----------|--------------|------|
| recaptcha_score_threshold | decimal(3,2) | 0.5 | この値を下回るとボットと判定 |

**値の範囲**: 0.0 〜 1.0
- 0.0に近い: 厳しい判定（より多くをボットと判定）
- 1.0に近い: 緩い判定（より多くを人間と判定）

**Googleの推奨閾値**: 0.5

### 2.2 外部APIキー

reCAPTCHA v3の利用には以下のAPIキーが必要：

| キー名 | 用途 | 保管方法 |
|--------|------|----------|
| サイトキー (Site Key) | フロントエンドでreCAPTCHAを初期化 | 環境変数 or Rails Credentials |
| シークレットキー (Secret Key) | サーバーサイドでトークン検証 | 環境変数 or Rails Credentials（秘密情報） |

**環境変数名**:
- `RECAPTCHA_SITE_KEY`
- `RECAPTCHA_SECRET_KEY`

**キー参照の優先順位**:
1. 環境変数を優先して参照
2. 環境変数がない場合はRails Credentialsから取得

### 2.3 リクエスト/レスポンスデータ

#### 2.3.1 フロントエンドからサーバーへの送信データ

| 項目名 | データ型 | 必須 | 説明 |
|--------|----------|------|------|
| g-recaptcha-response-data[project] | string | ○ | reCAPTCHAトークン |
| project[title] | string | ○ | プロジェクトタイトル（既存パラメータ） |
| project[owner_id] | integer | - | オーナーID（既存パラメータ） |

#### 2.3.2 Google reCAPTCHA API レスポンス

| 項目名 | データ型 | 説明 |
|--------|----------|------|
| success | boolean | 検証成功/失敗 |
| score | float | スコア（0.0〜1.0）|
| action | string | アクション名（検証用） |
| challenge_ts | string | チャレンジのタイムスタンプ |
| hostname | string | リクエスト元ホスト名 |
| error-codes | array | エラーコード（失敗時） |

## 3. 検証ロジック

### 3.1 reCAPTCHAスコア判定

#### 3.1.1 判定ルール

```
判定結果 = スコア >= 閾値 ? 人間 : ボット

スコア: Google reCAPTCHA APIから取得（0.0〜1.0）
閾値: システム設定から取得（デフォルト0.5）
```

判定手順：
1. Google reCAPTCHA APIからスコアを取得
2. システム設定から閾値を取得
3. スコアと閾値を比較
4. スコア >= 閾値 の場合、人間と判定（投稿許可）
5. スコア < 閾値 の場合、ボットと判定（投稿拒否）

#### 3.1.2 スコアの解釈

| スコア範囲 | 解釈 |
|------------|------|
| 0.9〜1.0 | 非常に高い確率で人間 |
| 0.7〜0.8 | おそらく人間 |
| 0.5〜0.6 | 判断が難しい領域 |
| 0.3〜0.4 | おそらくボット |
| 0.0〜0.2 | 非常に高い確率でボット |

### 3.2 アクション検証

reCAPTCHA v3では、トークン生成時に指定したアクション名とAPI検証結果のアクション名が一致することを確認する。

```
期待アクション: "project"（プロジェクト作成固有）
```

アクション名が一致しない場合は、トークンの不正使用の可能性があるため検証失敗とする。

## 4. ビジネスルール

### 4.1 処理優先順位

プロジェクト作成時の各種制限は以下の優先順位で評価される。

| 優先度 | 条件 | 動作 |
|--------|------|------|
| 1 | リードオンリーモード中 | エラーメッセージを表示し、投稿を拒否 |
| 2 | スパム投稿者 | サイレント拒否（成功したように見せかける） |
| 3 | reCAPTCHAトークン未送信 | エラーメッセージを表示し、投稿を拒否 |
| 4 | reCAPTCHA検証失敗 | エラーメッセージを表示し、投稿を拒否 |

**ルール詳細**:
- リードオンリーモード中はスパム投稿者であっても、リードオンリーモードのエラーメッセージを表示
- スパム投稿者かつreCAPTCHA検証失敗の場合、サイレント拒否が優先される（スパム投稿者への情報漏洩防止）

### 4.2 例外ユーザー

システム管理者（`authority`が`admin`のユーザー）は、reCAPTCHA検証をスキップする。

### 4.3 トークン必須

#### 4.3.1 トークン未送信時

reCAPTCHAトークンがリクエストに含まれていない場合、投稿を拒否する。

| 状況 | 動作 |
|------|------|
| JavaScriptが無効 | エラーメッセージを表示し、投稿を拒否 |
| トークン取得失敗 | エラーメッセージを表示し、投稿を拒否 |

**理由**: 本サイトはJavaScript無効環境での利用が困難であるため、JavaScript有効を前提とする

### 4.4 フォールバック動作

#### 4.4.1 API障害時

Google reCAPTCHA APIに接続できない場合の動作：

| 状況 | 動作 |
|------|------|
| タイムアウト | 検証をスキップして投稿を許可 |
| エラー応答（5xx） | 検証をスキップして投稿を許可 |
| 不正なレスポンス | 検証をスキップして投稿を許可 |

**理由**: 外部サービス障害によりユーザーが投稿できなくなることを防ぐため

### 4.5 APIキー未設定時

サイトキーまたはシークレットキーが設定されていない場合：

| 状況 | 動作 |
|------|------|
| 開発環境 | 検証をスキップして投稿を許可 |
| 本番環境 | 検証をスキップして投稿を許可（ただし警告ログを出力） |

## 5. 画面表示機能

### 5.1 プロジェクト作成フォーム

#### 5.1.1 reCAPTCHA v3の組み込み

- reCAPTCHA v3はユーザーに見えない形で動作する
- フォーム内にトークン送信用の隠しフィールドを追加
- フォーム送信時に自動的にトークンを取得・送信

#### 5.1.2 JavaScript無効時の案内

JavaScriptが無効な環境ではフォームを送信してもエラーとなるため、事前にユーザーへ案内を表示する。

**表示方法**: `<noscript>`タグを使用してJavaScript無効時のみメッセージを表示

**メッセージ内容**:
```
このサイトの利用にはJavaScriptを有効にする必要があります。ブラウザの設定を確認してください。
```

#### 5.1.3 reCAPTCHAバッジ

reCAPTCHA v3を使用する場合、Googleの利用規約により以下のいずれかが必要：

1. **reCAPTCHAバッジの表示**: 画面右下に自動表示されるバッジ
2. **テキスト表示**: バッジを非表示にする場合、以下のテキストを表示

```
This site is protected by reCAPTCHA and the Google Privacy Policy and Terms of Service apply.
```

**本機能での対応**: reCAPTCHAバッジをデフォルトで表示

### 5.2 管理画面

#### 5.2.1 スコア閾値設定画面

管理画面のシステム設定セクションにreCAPTCHAスコア閾値の設定項目を追加。

**表示項目**:
- 設定項目名: reCAPTCHAスコア閾値
- 入力フィールド: 数値入力（小数点以下2桁）
- 現在値の表示
- デフォルト値の説明（0.5）

**入力検証**:
- 0.0以上1.0以下の数値であること
- 小数点以下2桁まで

### 5.3 エラーハンドリング

#### 5.3.1 エラー分類

| エラーレベル | 説明 | 処理継続 | ユーザー通知 |
|-------------|------|----------|--------------|
| ERROR | reCAPTCHAトークン未送信 | 中止 | エラーメッセージ表示 |
| ERROR | reCAPTCHA検証失敗（ボット判定） | 中止 | エラーメッセージ表示 |
| WARNING | API障害によるフォールバック | 継続 | なし |
| INFO | 検証スキップ（システム管理者） | 継続 | なし |

#### 5.3.2 エラーメッセージ

**reCAPTCHAトークン未送信時**:
```
日本語: プロジェクトの投稿にはJavaScriptを有効にする必要があります。
英語: JavaScript must be enabled to post a project.
```

**reCAPTCHA検証失敗時**:
```
日本語: ボットによる投稿と判定されました。もう一度お試しください。
英語: Your request was identified as automated. Please try again.
```

## 6. 外部サービス連携

### 6.1 Google reCAPTCHA API

#### 6.1.1 APIエンドポイント

```
POST https://www.google.com/recaptcha/api/siteverify
```

#### 6.1.2 リクエストパラメータ

| パラメータ | 必須 | 説明 |
|------------|------|------|
| secret | ○ | シークレットキー |
| response | ○ | フロントエンドから受け取ったトークン |
| remoteip | - | ユーザーのIPアドレス（オプション） |

#### 6.1.3 タイムアウト設定

| 設定 | 値 |
|------|-----|
| 接続タイムアウト | 5秒 |
| 読み取りタイムアウト | 10秒 |

#### 6.1.4 リトライ

API障害時はリトライせず、即座にフォールバック動作を実行。

**理由**: ユーザーの待機時間を最小化するため

### 6.2 料金体系

| プラン | リクエスト数 | 料金 |
|--------|-------------|------|
| 無料枠 | 月間100万リクエストまで | 無料 |
| 有料枠 | 100万リクエスト超過分 | $1/1000リクエスト |

## 7. セキュリティ考慮事項

### 7.1 シークレットキーの保護

- シークレットキーはサーバーサイドでのみ使用
- フロントエンドには絶対に露出させない
- 環境変数またはRails Credentialsで管理

### 7.2 トークンの検証

- トークンは一度のみ使用可能（リプレイ攻撃防止）
- トークンの有効期限は2分間（Google側で管理）
- アクション名の一致を確認（トークンの不正流用防止）

### 7.3 ログ出力

reCAPTCHA検証結果をログに出力する際の注意事項：

| 出力可 | 出力不可 |
|--------|----------|
| スコア | シークレットキー |
| アクション名 | 完全なトークン |
| 判定結果 | ユーザー個人情報 |
| エラーコード | - |

---

**関連資料**:
- [スパムプロジェクト投稿抑制機能 要件定義書](../requirements/spam-prevention.md)
- [reCAPTCHA v3 セットアップガイド](../guides/recaptcha-setup.md)
- [reCAPTCHA v3 導入に必要なAPIキー調査報告書](../reports/recaptcha-api-investigation.md)
