# スパム検出ログ機能 要件定義書

**作成日**: 2026年1月23日
**更新日**: 2026年1月23日

## 1. 機能概要

スパム検出機能によってブロックされた投稿を記録し、管理者が検出状況を把握できるようにする機能。既存のスパム検出機能はRailsログに出力しているのみで、管理画面から確認する手段がないため、本機能で対応する。

**主要な提供価値**：
- スパム検出の動作状況を管理画面から確認できる
- どの程度の投稿がブロックされているか把握できる

## 2. 機能要件

### 2.1 スパム検出時のログ記録

#### 概要
スパム検出機能が投稿をブロックした際に、ログレコードをデータベースに記録する。

#### 記録対象
以下のスパム検出によるブロックを記録対象とする。

| 検出方法 | 説明 |
|----------|------|
| スパムキーワード検出 | `SpamKeywordDetector`によるキーワードマッチでのブロック |
| スパマー制限 | `Spammer`モデルに登録されたユーザーのサイレント拒否 |
| reCAPTCHA検証失敗 | reCAPTCHA v3のスコアが閾値を下回った場合のブロック |

#### 記録する情報

| 項目 | 説明 |
|------|------|
| 検出日時 | ブロックが発生した日時 |
| ユーザーID | ログインユーザーのID |
| IPアドレス | リクエスト元のIPアドレス |
| 検出方法 | スパムキーワード、スパマー制限、reCAPTCHAのいずれか |
| 検出理由 | マッチしたキーワード、reCAPTCHAスコアなど検出の詳細情報 |
| コンテンツ種別 | Project、NoteCard、State、Usage、Annotation、ProjectComment、CardCommentなど |

### 2.2 管理画面でのログ一覧表示

#### 概要
管理画面からスパム検出ログを一覧で確認できる。

#### 表示内容
記録された情報を新しい順に一覧表示する。

## 3. 前提条件・制約事項

### 3.1 前提条件

- **システム前提条件**：
  - 既存のスパム検出機能（SpamKeywordDetector、Spammerモデル、reCAPTCHA検証）が実装されていること
  - 管理画面（Admin機能）が存在すること

### 3.2 制約事項

- **データ保持**：
  - ログは無期限で保持する

### 3.3 依存関係

- 既存のSpamKeywordDetectorサービス
- 既存のSpammerモデル
- 既存のreCAPTCHA検証機能
- 既存のAdmin機能

## 4. 用語定義

| 用語 | 説明 |
|------|------|
| スパム検出ログ | スパム検出機能によって投稿がブロックされた際の記録 |
| スパムキーワード検出 | 登録されたキーワードとの部分文字列マッチングによるスパム判定 |
| スパマー制限 | Spammerテーブルに登録されたユーザーの投稿をサイレント拒否する機能 |
| reCAPTCHA検証 | Google reCAPTCHA v3によるボット判定 |
| コンテンツ種別 | ブロックされた投稿の種類（プロジェクト、カード、コメントなど） |

## 5. 受け入れ条件

### ログ記録
- [ ] スパムキーワード検出でブロックした際にログが記録されること
- [ ] スパマー制限でサイレント拒否した際にログが記録されること
- [ ] reCAPTCHA検証失敗でブロックした際にログが記録されること
- [ ] 各ログに検出日時、ユーザーID、IPアドレス、検出方法、検出理由、コンテンツ種別が記録されること

### 管理画面
- [ ] 管理画面からスパム検出ログの一覧を確認できること
- [ ] ログが新しい順に表示されること

---

## 改訂履歴

| バージョン | 日付 | 変更内容 |
|------------|------|----------|
| 1.0 | 2026/01/23 | 初版作成 |
