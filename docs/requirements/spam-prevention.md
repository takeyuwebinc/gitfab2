# スパムプロジェクト投稿抑制機能 要件定義書

**作成日**: 2026年1月5日
**更新日**: 2026年1月5日

## 1. 機能概要

ボットによる大量のスパムプロジェクト投稿を抑制するための機能。既存のスパム対策機能（Spammerモデル、コメントのスパムマーク機能）はコメントを対象としているが、プロジェクト投稿自体を抑制する機能が不足しているため、本機能で対応する。

**主要な提供価値**：
- スパムプロジェクト投稿によるプラットフォーム品質の低下を防止
- 管理者のスパム対応負荷を軽減
- 緊急時に投稿を一時停止できる運用手段の提供

## 2. 機能要件

### 2.1 一時的なリードオンリーモード

#### 概要
システム管理者が管理画面から設定することで、一時的にサイト全体を読み取り専用モードに切り替える。

#### 制限対象
リードオンリーモード中は以下の操作が制限される。
- 新規プロジェクト作成
- プロジェクトコメント投稿
- カードコメント投稿

#### 制限対象外
- 既存プロジェクトの編集

#### 例外ユーザー
- システム管理者（`is_system_admin?`がtrueのユーザー）は、リードオンリーモード中でも上記の操作が可能

#### 設定項目
管理画面から以下を設定できる。

| 設定項目 | 説明 |
|----------|------|
| モードの有効化/無効化 | リードオンリーモードのON/OFF |
| 自動解除日時 | 指定した日時に自動でモードを解除（任意設定） |

#### 解除方法
以下のいずれかの方法でリードオンリーモードを解除できる。
1. **手動解除**: システム管理者が管理画面から手動で解除
2. **タイマー解除**: 設定した自動解除日時に到達した時点で自動解除

#### ユーザーへの通知
リードオンリーモード中は以下の方法でユーザーに通知する。
1. **サイト全体のバナー表示**: サイト上部にリードオンリーモード中であることを告知するバナーを表示（システム管理者・一般ユーザー・未ログインユーザー全員に表示）
2. **フォームでのエラーメッセージ表示**: 制限対象の操作を試みた際に、現在投稿ができない旨のエラーメッセージを表示

### 2.2 新規プロジェクト投稿時のreCAPTCHA機能

#### 概要
新規プロジェクト作成時にreCAPTCHA v3による認証を行い、ボットによる自動投稿を防止する。

#### 対象画面
- 新規プロジェクト作成フォーム

#### 基本処理フロー
1. ユーザーがプロジェクト作成フォームを表示した際に、reCAPTCHA v3のトークンを取得
2. フォーム送信時にトークンをサーバーに送信
3. サーバー側でGoogleのreCAPTCHA APIを使用してトークンを検証
4. スコアが閾値を下回る場合、投稿を拒否

#### 設定項目
管理画面から以下を設定できる。

| 設定項目 | 説明 | デフォルト値 |
|----------|------|--------------|
| スコア閾値 | この値を下回るとボットと判定して投稿を拒否 | 0.5（一般的な推奨値） |

#### 検証失敗時の動作
reCAPTCHA検証に失敗した場合、プロジェクト作成を拒否し、エラーメッセージを表示する。

#### API障害時の動作
Google reCAPTCHA APIに接続できない場合（タイムアウト、エラー応答等）は、reCAPTCHA検証をスキップして投稿を許可する（フォールバック）。

### 2.3 スパム投稿者のプロジェクト作成制限

#### 概要
既存のSpammerモデルを活用し、スパム投稿者として登録されているユーザーの新規プロジェクト作成を制限する。

#### 判定基準
`user.spammer?`がtrueの場合、スパム投稿者として扱う。

#### 制限内容
スパム投稿者は新規プロジェクトを作成できない。

#### 制限時の動作
スパム投稿者がプロジェクト作成を試みた場合、**投稿が成功したように見せかける**（サイレント拒否）。
- フォーム送信後、マイページ（プロジェクト一覧）に遷移
- 実際にはプロジェクトは作成されない
- エラーメッセージは表示しない

この動作により、スパム投稿者が制限を認識して対策を講じることを防ぐ。

#### 制限の解除
システム管理者が管理画面からSpammerレコードを削除することで制限を解除できる。

### 2.4 処理の優先順位

複数の制限条件に該当する場合の処理優先順位を以下に定める。

| 優先度 | 条件 | 動作 |
|--------|------|------|
| 1 | リードオンリーモード中 | エラーメッセージを表示し、投稿を拒否 |
| 2 | スパム投稿者 | サイレント拒否（成功したように見せかける） |
| 3 | reCAPTCHA検証失敗 | エラーメッセージを表示し、投稿を拒否 |

※リードオンリーモード中はスパム投稿者であっても、リードオンリーモードのエラーメッセージを表示する

### 2.5 エラー処理

- **reCAPTCHA検証失敗時**: エラーメッセージを表示し、再試行を促す
- **reCAPTCHA API障害時**: 検証をスキップして投稿を許可する
- **リードオンリーモード中の投稿試行**: エラーメッセージを表示し、投稿を拒否
- **スパム投稿者の投稿試行**: 成功したように見せかける（サイレント拒否）、マイページに遷移

## 3. 前提条件・制約事項

### 3.1 前提条件

- **システム前提条件**：
  - 既存のSpammerモデルが存在すること
  - 管理画面（Admin機能）が存在すること
  - システム管理者判定（`is_system_admin?`）が実装されていること

- **外部サービス前提条件**：
  - Google reCAPTCHA v3のAPIキーが取得済みであること

### 3.2 制約事項

- **技術的制約**：
  - reCAPTCHA v3の利用にはGoogle reCAPTCHAのAPIキーが必要
  - リードオンリーモードの自動解除はバックグラウンド処理基盤に依存する

### 3.3 依存関係

- 既存のSpammerモデル
- 既存のAdmin機能

## 4. 用語定義

| 用語 | 説明 |
|------|------|
| リードオンリーモード | 新規投稿・コメントを一時的に制限するシステム状態 |
| スパム投稿者 | Spammerテーブルにレコードが存在するユーザー |
| システム管理者 | `authority`が`admin`のユーザー |
| reCAPTCHA v3 | Googleが提供するボット検知サービス。ユーザー操作不要でスコアベースの自動判定を行う |
| サイレント拒否 | エラーを表示せず、成功したように見せかけて実際には処理を行わない方式 |
| フォールバック | 外部サービス障害時に代替動作を行うこと |
| スコア閾値 | reCAPTCHA v3の判定基準となる値。0.0〜1.0の範囲で、低いほど厳しい判定 |

## 5. 受け入れ条件

### リードオンリーモード
- [ ] 管理画面からリードオンリーモードを有効化/無効化できること
- [ ] リードオンリーモード中、一般ユーザーは新規プロジェクトを作成できないこと
- [ ] リードオンリーモード中、一般ユーザーはコメントを投稿できないこと
- [ ] リードオンリーモード中、一般ユーザーは既存プロジェクトを編集できること
- [ ] リードオンリーモード中、システム管理者は新規プロジェクト作成・コメント投稿ができること
- [ ] 自動解除日時を設定した場合、指定日時に自動でモードが解除されること
- [ ] リードオンリーモード中、サイト上部にバナーが全ユーザーに表示されること
- [ ] リードオンリーモード中、投稿を試みた際にエラーメッセージが表示されること

### reCAPTCHA機能
- [ ] 新規プロジェクト作成時にreCAPTCHA v3による検証が行われること
- [ ] 管理画面からreCAPTCHAのスコア閾値を設定できること
- [ ] スコア閾値のデフォルト値が0.5であること
- [ ] reCAPTCHA検証に失敗した場合、プロジェクト作成が拒否されること
- [ ] reCAPTCHA検証に失敗した場合、エラーメッセージが表示されること
- [ ] reCAPTCHA APIに接続できない場合、投稿が許可されること

### スパム投稿者制限
- [ ] スパム投稿者が新規プロジェクトを作成しようとした場合、マイページに遷移すること
- [ ] スパム投稿者が新規プロジェクトを作成しようとした場合、実際にはプロジェクトが作成されないこと
- [ ] システム管理者がSpammerレコードを削除すると、制限が解除されること

### 処理優先順位
- [ ] リードオンリーモード中にスパム投稿者が投稿を試みた場合、エラーメッセージが表示されること
- [ ] スパム投稿者かつreCAPTCHA検証失敗の場合、サイレント拒否が優先されること

## 6. 今後の拡張予定（対象外）

以下の機能は今回の対象外とする。
- 既存プロジェクト編集へのreCAPTCHA適用
- コメント投稿へのreCAPTCHA適用
- スパム投稿者の解除申請機能
- グループ管理者などの例外設定
- ユーザー登録時のスパム対策

---

## 改訂履歴

| バージョン | 日付 | 変更内容 |
|------------|------|----------|
| 1.0 | 2026/01/05 | 初版作成 |
| 1.1 | 2026/01/05 | 精査結果を反映：処理優先順位、API障害時動作、バナー表示対象、遷移先、reCAPTCHAスコア閾値の管理画面設定を追加 |
