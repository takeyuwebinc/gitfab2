# プロジェクト管理機能改修 要件定義書

**作成日**: 2026年1月5日
**更新日**: 2026年1月5日

## 1. 機能概要

管理画面におけるプロジェクト管理機能を改修し、スパム対応業務の効率化を図る。複数プロジェクトの一括操作、スパムキーワードによる自動判定、操作性の改善を実現する。

**主要な提供価値**：
- 複数プロジェクトの一括操作によるスパム対応時間の短縮
- スパムキーワードによる自動判定で手動対応件数を削減
- 管理画面の操作性向上による作業効率の改善

## 2. 機能要件

### 2.1 まとめてスパム認定機能

#### 対象画面
- 管理画面 プロジェクト一覧（`/admin/projects`）

#### 処理フロー

1. **プロジェクト選択**
   - プロジェクト一覧の各行にチェックボックスを表示する
   - ヘッダー行に全選択/全解除のチェックボックスを表示する
   - 選択対象は現在表示中のページ内のプロジェクトのみとする

2. **一括操作の実行**
   - 「まとめてスパム認定」ボタンを一覧上部に配置する
   - 選択中の件数を表示する
   - 未選択時はボタンを非活性とする
   - 実行前に確認ダイアログを表示する

3. **スパム認定処理**
   - プロジェクトのオーナーをSpammerとして登録する
     - オーナーがUserの場合：そのユーザーを登録
     - オーナーがGroupの場合：グループのメンバー全員を登録
   - プロジェクトを論理削除する
   - 一部のプロジェクトで処理が失敗した場合も、残りのプロジェクトは継続して処理する

### 2.2 リンクの新規タブ表示

#### 対象画面
- 管理画面 プロジェクト一覧（`/admin/projects`）

#### 変更内容
- 「Open」リンク（公開ページへのリンク）を新規タブで開く
- 「Manage」リンク（管理画面詳細へのリンク）を新規タブで開く

### 2.3 スパム認定ボタンの視認性向上

#### 対象画面
- 管理画面 プロジェクト詳細（`/admin/projects/:id`）

#### 変更内容
- スパム認定ボタン（現在の「削除」ボタン）のサイズを拡大する
- ボタンを目立つ色（警告色）で表示する

### 2.4 スパムキーワード管理機能

#### 2.4.1 キーワードの管理画面

**対象画面**
- 管理画面 スパムキーワード一覧（新規：`/admin/spam_keywords`）

**機能**
- キーワードの一覧表示
- キーワードの新規追加
- キーワードの編集
- キーワードの削除
- キーワードの有効/無効切り替え

#### 2.4.2 キーワードのデータ項目

| 項目 | 説明 |
|------|------|
| キーワード | スパム判定に使用する文字列（重複不可） |
| 有効フラグ | キーワードの有効/無効状態 |

#### 2.4.3 キーワード検出

**検出対象**
- プロジェクト：プロジェクト名（name）、タイトル（title）、説明（description）
- プロジェクトコメント：本文
- カードコメント：本文

**検出条件**
- 部分一致で判定する
- 大文字・小文字を区別しない
- 有効なキーワードのみを検出対象とする

**検出タイミング**
- プロジェクト作成時
- プロジェクト更新時
- コメント投稿時

**検出時の動作**
- 投稿処理をサイレントに拒否する（成功したように見せかけて実際には保存しない）
- 投稿者のSpammer登録は行わない（部分一致による誤検知の可能性があるため）

**除外条件**
- システム管理者からの投稿はキーワード検出の対象外とする

### 2.5 用語の統一

#### 対象画面
- 管理画面 プロジェクト一覧（`/admin/projects`）
- 管理画面 プロジェクト詳細（`/admin/projects/:id`）

#### 変更内容
- 「削除」→「スパム認定」に表記を変更する

#### スパム認定時の動作
- プロジェクトのオーナーをSpammerとして登録する
  - オーナーがUserの場合：そのユーザーを登録
  - オーナーがGroupの場合：グループのメンバー全員を登録
- プロジェクトを論理削除する（既存の`soft_destroy!`処理）

## 3. 前提条件・制約事項

### 3.1 前提条件

- **システム前提条件**：
  - 既存のSpammerモデルが存在すること
  - 管理画面（Admin機能）が存在すること
  - プロジェクトの論理削除機能が存在すること

### 3.2 制約事項

- **技術的制約**：
  - 一括操作はページネーション単位で行う（複数ページにまたがる一括選択は対象外）
  - スパムキーワード検出は投稿時のみ行う（既存投稿の遡及チェックは行わない）

### 3.3 依存関係

- 既存のSpammerモデル
- 既存のAdmin機能

## 4. 用語定義

| 用語 | 説明 |
|------|------|
| スパム認定 | プロジェクトのオーナー（Groupの場合はメンバー全員）をSpammerとして登録し、プロジェクトを論理削除する操作 |
| スパム投稿者（Spammer） | Spammerテーブルにレコードが存在するユーザー |
| システム管理者 | `authority`が`admin`のユーザー |
| スパムキーワード | 投稿内容に含まれる場合にサイレント拒否するキーワード |
| サイレント拒否 | 成功したように見せかけて実際には処理を行わない方式 |
| 論理削除 | データベースから物理的に削除せず、削除フラグを立てる方式 |

## 5. 受け入れ条件

### まとめてスパム認定機能
- [ ] プロジェクト一覧でチェックボックスによる複数選択ができること
- [ ] 全選択/全解除チェックボックスが機能すること
- [ ] 選択件数が画面上に表示されること
- [ ] 「まとめてスパム認定」で選択プロジェクトを一括処理できること
- [ ] 一括操作前に確認ダイアログが表示されること
- [ ] 未選択時は一括操作ボタンが非活性であること
- [ ] 一部失敗しても残りのプロジェクトは継続して処理されること

### リンクの新規タブ表示
- [ ] 「Open」リンクが新規タブで開くこと
- [ ] 「Manage」リンクが新規タブで開くこと

### スパム認定ボタンの視認性向上
- [ ] プロジェクト詳細画面のボタンが拡大されていること
- [ ] ボタンが警告色で表示されていること

### スパムキーワード管理
- [ ] 管理画面でキーワードを追加できること
- [ ] 管理画面でキーワードを編集できること
- [ ] 管理画面でキーワードを削除できること
- [ ] キーワードの有効/無効を切り替えられること
- [ ] 重複するキーワードは登録できないこと

### スパムキーワード検出
- [ ] キーワードを含むプロジェクト作成がサイレント拒否されること
- [ ] キーワードを含むプロジェクト更新がサイレント拒否されること
- [ ] キーワードを含むコメント投稿がサイレント拒否されること
- [ ] 大文字・小文字を区別せずに検出されること
- [ ] 無効化されたキーワードは検出対象外であること
- [ ] システム管理者の投稿は検出対象外であること

### 用語の統一・スパム認定
- [ ] プロジェクト一覧のボタン表記が「スパム認定」に変更されていること
- [ ] プロジェクト詳細のボタン表記が「スパム認定」に変更されていること
- [ ] スパム認定するとオーナー（User）がSpammerとして登録されること
- [ ] スパム認定するとオーナー（Group）のメンバー全員がSpammerとして登録されること
- [ ] スパム認定するとプロジェクトが論理削除されること

## 6. 今後の拡張予定（対象外）

以下は今回の対象外とする。

- 複数ページにまたがる一括選択機能
- 既存投稿に対するスパムキーワードの遡及チェック
- コメント管理画面でのまとめてスパム認定機能
- コメント管理画面での用語統一

---

## 改訂履歴

| バージョン | 日付 | 変更内容 |
|------------|------|----------|
| 1.0 | 2026/01/05 | 初版作成 |
